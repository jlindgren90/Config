#!/bin/bash

setup_one() {
  xrandr --auto
  if xrandr | grep -q "panning" ; then
    # nvidia enables panning if external monitor is
    # unplugged while suspended; try to disable it
    xrandr --output $1 --panning 0x0
  fi
}

setup_two() {
  if test -f ~/.config/enable-dual-displays ; then
    xrandr --output $1 --auto \
           --output $2 --auto --primary --right-of $1
  else
    xrandr --output $1 --off \
           --output $2 --auto --primary
  fi
}

setup_three() {
  if [[ $2 == DP-*.1 && $3 == DP-*.2 ]] ; then
    # work around a hardware limitation: alpine ridge controller with
    # USB alt-mode dock (2 DP lanes) can push 8.6 Gbps, just enough for
    # one 1440p + one 1080p signal
    mode3="--mode 1920x1080"
  else
    mode3="--auto"
  fi

  if test -f ~/.config/enable-dual-displays ; then
    xrandr --output $1 --auto \
           --output $2 --auto --primary --right-of $1 \
           --output $3 $mode3 --right-of $2
  else
    xrandr --output $1 --off \
           --output $2 --auto --primary \
           --output $3 $mode3 --right-of $2
  fi
}

outputs=($(xrandr | grep " connected" | sort | cut -d" " -f1))

if [[ " ${outputs[@]} " =~ " eDP-1 " ]] ; then
  internal=eDP-1 # intel
elif [[ " ${outputs[@]} " =~ " DP-3 " ]] ; then
  internal=DP-3 # nvidia
else
  internal=${outputs[0]}
fi

external=(${outputs[@]/$internal})
nexternal=${#external[@]}

if [[ $nexternal == 0 ]] ; then
  setup_one $internal
elif [[ $nexternal == 1 ]] ; then
  setup_two $internal ${external[0]}
else
  setup_three $internal ${external[0]} ${external[1]}
fi

feh --bg-fill "$HOME/.wallpaper.jpg"
